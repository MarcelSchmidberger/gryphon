<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes/fragment.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/arrayEquals.html">arrayEquals</a></li>
                                <li><a href="../classes/changeDClassAttrReferences.html">changeDClassAttrReferences</a></li>
                                <li><a href="../classes/changeDClassReferences.html">changeDClassReferences</a></li>
                                <li><a href="../classes/deleteExportTarget.html">deleteExportTarget</a></li>
                                <li><a href="../classes/deleteFragment.html">deleteFragment</a></li>
                                <li><a href="../classes/deleteScenario.html">deleteScenario</a></li>
                                <li><a href="../classes/DomainModelSchema.html">DomainModelSchema</a></li>
                                <li><a href="../classes/EventValidator.html">EventValidator</a></li>
                                <li><a href="../classes/ExportSchema.html">ExportSchema</a></li>
                                <li><a href="../classes/FragmentSchema.html">FragmentSchema</a></li>
                                <li><a href="../classes/GeneralValidator.html">GeneralValidator</a></li>
                                <li><a href="../classes/getAssociatedDomainModelFragment.html">getAssociatedDomainModelFragment</a></li>
                                <li><a href="../classes/getDomainModel.html">getDomainModel</a></li>
                                <li><a href="../classes/getDomainModels.html">getDomainModels</a></li>
                                <li><a href="../classes/getExportTargets.html">getExportTargets</a></li>
                                <li><a href="../classes/getFragment.html">getFragment</a></li>
                                <li><a href="../classes/getFragments.html">getFragments</a></li>
                                <li><a href="../classes/getFragmentStructure.html">getFragmentStructure</a></li>
                                <li><a href="../classes/getFragmentXML.html">getFragmentXML</a></li>
                                <li><a href="../classes/getScenario.html">getScenario</a></li>
                                <li><a href="../classes/getScenarios.html">getScenarios</a></li>
                                <li><a href="../classes/getValidateExportURL.html">getValidateExportURL</a></li>
                                <li><a href="../classes/getValidateFragment.html">getValidateFragment</a></li>
                                <li><a href="../classes/getValidateScenario.html">getValidateScenario</a></li>
                                <li><a href="../classes/OLCValidator.html">OLCValidator</a></li>
                                <li><a href="../classes/parseToBPMNObject.html">parseToBPMNObject</a></li>
                                <li><a href="../classes/parseToOLC.html">parseToOLC</a></li>
                                <li><a href="../classes/postAssociateDomainmodelToScenario.html">postAssociateDomainmodelToScenario</a></li>
                                <li><a href="../classes/postAssociateFragmentToScenario.html">postAssociateFragmentToScenario</a></li>
                                <li><a href="../classes/postDomainModel.html">postDomainModel</a></li>
                                <li><a href="../classes/postExportTarget.html">postExportTarget</a></li>
                                <li><a href="../classes/postFragment.html">postFragment</a></li>
                                <li><a href="../classes/postNewDomainModel.html">postNewDomainModel</a></li>
                                <li><a href="../classes/postNewExportTarget.html">postNewExportTarget</a></li>
                                <li><a href="../classes/postNewFragment.html">postNewFragment</a></li>
                                <li><a href="../classes/postNewScenario.html">postNewScenario</a></li>
                                <li><a href="../classes/postScenario.html">postScenario</a></li>
                                <li><a href="../classes/postScenarioExport.html">postScenarioExport</a></li>
                                <li><a href="../classes/ScenarioSchema.html">ScenarioSchema</a></li>
                                <li><a href="../classes/SoundnessValidator.html">SoundnessValidator</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/helpers.array.html">helpers.array</a></li>
                                <li><a href="../modules/helpers.json.html">helpers.json</a></li>
                                <li><a href="../modules/helpers.updaterefs.html">helpers.updaterefs</a></li>
                                <li><a href="../modules/helpers.validator.html">helpers.validator</a></li>
                                <li><a href="../modules/models.domainmodel.html">models.domainmodel</a></li>
                                <li><a href="../modules/models.export.html">models.export</a></li>
                                <li><a href="../modules/models.fragment.html">models.fragment</a></li>
                                <li><a href="../modules/models.scenario.html">models.scenario</a></li>
                                <li><a href="../modules/routes.domainmodel.html">routes.domainmodel</a></li>
                                <li><a href="../modules/routes.export.html">routes.export</a></li>
                                <li><a href="../modules/routes.fragment.html">routes.fragment</a></li>
                                <li><a href="../modules/routes.scenario.html">routes.scenario</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: routes/fragment.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var express = require(&#x27;express&#x27;);
var router = express.Router();
var Config = require(&#x27;./../../config&#x27;);
var Fragment = require(&#x27;./../models/fragment&#x27;).model;
var Scenario = require(&#x27;./../models/scenario&#x27;).model;
var JSONHelper = require(&#x27;./../helpers/json&#x27;);
var Validator = require(&#x27;./../helpers/validator&#x27;).Validator;

/**
 * You can find further information about all endpoints in the swagger.yaml
 * @module routes.fragment
 */

/**
 * Returns the fragment with the given ID
 * @class getFragment
 */
router.get(&#x27;/:fragID&#x27;, function(req, res) {
    var id = req.params.fragID;
    var deliver_xml = req.query.deliver_xml;
    Fragment.findOne({_id:id},function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {
            if (!deliver_xml) {
                delete result.content;
            }
            res.json(result)
        } else {
            res.status(404).end();
        }
    });
});

/**
 * Update the fragment with the given ID.
 * @class postFragment
 */
router.post(&#x27;/:fragID&#x27;, function(req, res) {
    var frag_id = req.params.fragID;
    var new_frag = req.body;

    Fragment.findOne({_id:frag_id}, function(err,result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {

            var changed = false;

            if (new_frag.name != null &amp;&amp; result.name !== new_frag.name) {
                changed = true;
                result.name = new_frag.name;
            }

            if (new_frag.content != null &amp;&amp; result.content !== new_frag.content) {
                changed = true;
                result.content = new_frag.content;
            }

            if (changed) {
                result.revision++;
                result.save(function(err){
                    if(err) {
                        console.error(err);
                        res.status(500).end();
                    }
                });
            }

            res.json(result);
        } else {
            res.status(404).end();
        }
    })
});

/**
 * Returns all fragments. This list can be filtered by the name of the fragments by using the query parameter.
 * @class getFragments
 */
router.get(&#x27;/&#x27;, function(req, res) {
    var name = req.query.query;

    Fragment.model.find({name: new RegExp(&#x27;^&#x27;+name+&#x27;$&#x27;, &quot;i&quot;)},function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {

            var res_object = {
                content_length: result.length,
                fragments: result
            };

            res.json(res_object)
        } else {
            res.status(404).end();
        }
    });
});

/**
 * Creates a new fragment with the given name.
 * @class postNewFragment
 */
router.post(&#x27;/&#x27;, function(req, res) {
    var fragment = req.body;
    var db_fragment = new Fragment({
        name: fragment.name,
        content: (fragment.content ? fragment.content : Config.DEFAULT_FRAGMENT_XML),
        revision: 1
    });

    db_fragment.save(function(err){
        if (err) {
            console.error(err);
            res.status(500).end();
        } else {
            res.json(db_fragment);
        }
    });
});

/**
 * Returns the structure of the fragment parsed into an JSON-object.
 * @class getFragmentStructure
 */
router.get(&#x27;/:fragID/structure&#x27;, function(req, res) {
    var id = req.params.fragID;
    Fragment.findOne({_id:id},function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {
            var parsed = JSONHelper.parseToBPMNObject(result.content);
            res.json(parsed);
        } else {
            res.status(404).end();
        }
    });
});

/**
 * Returns the xml of the given fragment.
 * @class getFragmentXML
 */
router.get(&#x27;/:fragID/xml&#x27;, function(req, res){
    var id = req.params.fragID;
    Fragment.findOne({_id:id},function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {
            res.set(&#x27;Content-Type&#x27;,&#x27;text/xml&#x27;);
            res.send(result.content);
        } else {
            res.status(404).end();
        }
    });
});

/**
 * Deletes the given fragment
 * @class deleteFragment
 */
router.delete(&#x27;/:fragID&#x27;, function(req, res) {
    var id = req.params.fragID;
    Fragment.findOne({_id:id},function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {
            result.remove();
        } else {
            res.status(404).end();
        }
    });
});

/**
 * Validates the given fragment.
 * @class getValidateFragment
 */
router.get(&#x27;/:fragID/validate&#x27;, function(req, res) {
   var id = req.params.fragID;
    Fragment.findOne({_id:id},function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {
            var validator = new Validator(result,function() {
                validator.validateEverything();
                res.json({
                    messages:validator.messages
                })
            });
        } else {
            res.status(404).end();
        }
    })
});

/**
 * Returns the domainmodel this fragment is associated with.
 * @class getAssociatedDomainModelFragment
 */
router.get(&#x27;/:fragID/assocdomainmodel&#x27;, function(req, res){
    Scenario.findOne({fragments:req.params.fragID}).populate(&#x27;domainmodel&#x27;).exec(function(err, result){
        if (err) {
            console.error(err);
            res.status(500).end();
            return;
        }
        if (result !== null) {
            res.json(result.domainmodel);
        } else {
            res.status(404).end();
        }
    });
});

module.exports = router;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
